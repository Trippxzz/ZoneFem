{% extends 'base.html' %}
{% load static %}

{% block title %}Gestión de Anuncios{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold text-purple mb-2">
                <i class="fas fa-bullhorn mr-2"></i>
                Gestión de Anuncios
            </h1>
            <p class="text-purple/80">Administra los anuncios del carrusel principal</p>
        </div>
        <div class="flex gap-3">
            <a href="{% url 'admin_crear_anuncio' %}" 
               class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all shadow-lg">
                <i class="fas fa-plus mr-2"></i>
                Nuevo Anuncio
            </a>
            <a href="{% url 'panel_matrona' %}" 
               class="px-6 py-3 bg-white text-purple-600 rounded-lg hover:bg-purple-50 transition-all shadow-lg">
                <i class="fas fa-arrow-left mr-2"></i>
                Volver al Panel
            </a>
        </div>
    </div>

    <!-- Mensajes -->
    {% if messages %}
        <div class="mb-6">
            {% for message in messages %}
                <div class="bg-{% if message.tags == 'success' %}green{% elif message.tags == 'error' %}red{% else %}blue{% endif %}-500 text-white px-6 py-4 rounded-lg shadow-lg mb-3">
                    <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% else %}info-circle{% endif %} mr-2"></i>
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Contenido Principal -->
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
        
        {% if anuncios %}
            <!-- Tabla de Anuncios -->
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white">
                        <tr>
                            <th class="px-6 py-4 text-left text-sm font-semibold w-8">
                                #
                            </th>
                            <th class="px-6 py-4 text-left text-sm font-semibold">
                                <i class="fas fa-text-width mr-2"></i>Texto del Anuncio
                            </th>
                            <th class="px-6 py-4 text-left text-sm font-semibold">
                                <i class="fas fa-link mr-2"></i>Link
                            </th>
                            <th class="px-6 py-4 text-left text-sm font-semibold">
                                <i class="fas fa-calendar mr-2"></i>Vigencia
                            </th>
                            <th class="px-6 py-4 text-center text-sm font-semibold">
                                <i class="fas fa-toggle-on mr-2"></i>Estado
                            </th>
                            <th class="px-6 py-4 text-center text-sm font-semibold">
                                <i class="fas fa-cogs mr-2"></i>Acciones
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for anuncio in anuncios %}
                        <tr class="hover:bg-purple-50 transition-colors">
                            <td class="px-6 py-4 text-center text-gray-500 font-mono">
                                {{ forloop.counter }}
                            </td>
                            <td class="px-6 py-4">
                                <p class="font-medium text-gray-900">{{ anuncio.texto }}</p>
                            </td>
                            <td class="px-6 py-4 text-sm">
                                {% if anuncio.enlace %}
                                <a href="{{ anuncio.enlace }}" target="_blank" class="text-blue-600 hover:text-blue-800 flex items-center gap-1">
                                    <i class="fas fa-external-link-alt text-xs"></i>
                                    <span class="truncate max-w-xs">{{ anuncio.texto_enlace }}</span>
                                </a>
                                {% else %}
                                <span class="text-gray-400">-</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-sm">
                                {% if anuncio.fecha_inicio %}
                                <p class="text-gray-600">
                                    <i class="fas fa-play-circle mr-1"></i>{{ anuncio.fecha_inicio|date:"d/m/Y" }}
                                </p>
                                {% endif %}
                                {% if anuncio.fecha_fin %}
                                <p class="text-gray-600">
                                    <i class="fas fa-stop-circle mr-1"></i>{{ anuncio.fecha_fin|date:"d/m/Y" }}
                                </p>
                                {% endif %}
                                {% if not anuncio.fecha_inicio and not anuncio.fecha_fin %}
                                <p class="text-gray-500 italic">Sin límite</p>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-center">
                                {% if anuncio.activo %}
                                    {% if anuncio.esta_vigente %}
                                    <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium">
                                        <i class="fas fa-check-circle mr-1"></i>Activo
                                    </span>
                                    {% else %}
                                    <span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-medium">
                                        <i class="fas fa-clock mr-1"></i>Programado
                                    </span>
                                    {% endif %}
                                {% else %}
                                <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs font-medium">
                                    <i class="fas fa-times-circle mr-1"></i>Inactivo
                                </span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center justify-center gap-2">
                                    <a href="{% url 'admin_editar_anuncio' anuncio.id %}" 
                                       class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all text-sm">
                                        <i class="fas fa-edit mr-1"></i>
                                        Editar
                                    </a>
                                    <button onclick="toggleAnuncio({{ anuncio.id }}, '{{ anuncio.titulo }}', {{ anuncio.activo|lower }})" 
                                            class="px-4 py-2 {% if anuncio.activo %}bg-yellow-500 hover:bg-yellow-600{% else %}bg-green-500 hover:bg-green-600{% endif %} text-white rounded-lg transition-all text-sm">
                                        <i class="fas fa-{% if anuncio.activo %}eye-slash{% else %}eye{% endif %} mr-1"></i>
                                        {% if anuncio.activo %}Desactivar{% else %}Activar{% endif %}
                                    </button>
                                    <button onclick="confirmarEliminar({{ anuncio.id }}, '{{ anuncio.titulo }}')" 
                                            class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all text-sm">
                                        <i class="fas fa-trash mr-1"></i>
                                        Eliminar
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-16">
                <i class="fas fa-bullhorn text-6xl text-gray-300 mb-4"></i>
                <p class="text-gray-500 text-lg mb-4">No hay anuncios registrados</p>
                <a href="{% url 'admin_crear_anuncio' %}" 
                   class="inline-block px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-all shadow-lg">
                    <i class="fas fa-plus mr-2"></i>
                    Crear Primer Anuncio
                </a>
            </div>
        {% endif %}
        
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function toggleAnuncio(anuncioId, anuncioTitulo, estadoActual) {
    const accion = estadoActual ? 'desactivar' : 'activar';
    if (confirm(`¿Estás seguro de que deseas ${accion} el anuncio "${anuncioTitulo}"?`)) {
        const csrftoken = getCookie('csrftoken');
        fetch(`/gestion/anuncios/toggle/${anuncioId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.mensaje);
                location.reload();
            } else {
                alert(data.error || 'Error al cambiar el estado');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ocurrió un error al cambiar el estado del anuncio');
        });
    }
}

function confirmarEliminar(anuncioId, anuncioTitulo) {
    if (confirm(`¿Estás seguro de que deseas ELIMINAR el anuncio "${anuncioTitulo}"?\n\nEsta acción no se puede deshacer.`)) {
        const csrftoken = getCookie('csrftoken');
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/gestion/anuncios/eliminar/${anuncioId}/`;
        
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrftoken;
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
