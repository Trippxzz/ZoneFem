{% extends "base.html" %}
{% load static %}

{% block title %}Carrito de Compras{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-8 text-center bg-clip-text text-transparent bg-gradient-to-r from-instagram-purple via-instagram-pink to-instagram-orange">
        <i class="fas fa-shopping-cart"></i> Tu Carrito
    </h1>

    {% if items %}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Items del carrito -->
        <div class="lg:col-span-2 space-y-4">
            {% for item in items %}
            <div class="bg-white rounded-xl shadow-md p-6 border border-border-color hover:shadow-lg transition-shadow">
                <div class="flex justify-between items-start">
                    <div class="flex gap-4 flex-1">
                        <!-- Imagen -->
                        <div class="w-24 h-24 rounded-lg overflow-hidden bg-gradient-to-br from-instagram-purple/20 to-instagram-pink/20 flex-shrink-0">
                            {% if item.servicio and item.servicio.imagenes.exists %}
                                {% with imagen=item.servicio.imagenes.all|first %}
                                <img src="{{ imagen.imagen.url }}" alt="{{ item.servicio.nombre }}" class="w-full h-full object-cover">
                                {% endwith %}
                            {% elif item.curso and item.curso.imagenes_curso.exists %}
                                {% with imagen=item.curso.imagenes_curso.all|first %}
                                <img src="{{ imagen.imagen.url }}" alt="{{ item.curso.nombre }}" class="w-full h-full object-cover">
                                {% endwith %}
                            {% else %}
                                <div class="w-full h-full flex items-center justify-center">
                                    <i class="fas fa-{% if item.curso %}graduation-cap{% else %}calendar-check{% endif %} text-3xl text-instagram-purple opacity-50"></i>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Información -->
                        <div class="flex-1">
                            <!-- Badge de tipo -->
                            {% if item.curso %}
                            <span class="inline-block px-3 py-1 bg-instagram-cyan text-white rounded-full text-xs font-medium mb-2">
                                <i class="fas fa-graduation-cap mr-1"></i> Curso Online
                            </span>
                            {% else %}
                            <span class="inline-block px-3 py-1 bg-instagram-pink text-white rounded-full text-xs font-medium mb-2">
                                <i class="fas fa-calendar-check mr-1"></i> Servicio
                            </span>
                            {% endif %}
                            
                            <h3 class="text-xl font-bold text-text-dark mb-2">{{ item.nombre }}</h3>
                            
                            {% if item.servicio %}
                                <p class="text-text-light mb-3">{{ item.servicio.descripcion|truncatewords:20 }}</p>
                                
                                {% if item.reserva_asociada %}
                                <div class="bg-blue-50 rounded-lg p-3 mb-3 border border-blue-200">
                                    <p class="text-sm text-blue-800 font-medium mb-1">
                                        <i class="fas fa-calendar-alt"></i> 
                                        Fecha: {{ item.reserva_asociada.fecha|date:"d/m/Y" }}
                                    </p>
                                    <p class="text-sm text-blue-800 font-medium mb-1">
                                        <i class="fas fa-clock"></i> 
                                        Hora: {{ item.reserva_asociada.hora_inicio|time:"H:i" }} - {{ item.reserva_asociada.hora_fin|time:"H:i" }}
                                    </p>
                                    <p class="text-sm text-blue-800 font-medium">
                                        <i class="fas fa-user-md"></i> 
                                        Matrona: {{ item.reserva_asociada.matrona.first_name }}
                                    </p>
                                </div>
                                {% endif %}
                            {% elif item.curso %}
                                <p class="text-text-light mb-3">{{ item.curso.descripcion|truncatewords:15 }}</p>
                                <div class="bg-cyan-50 rounded-lg p-3 mb-3 border border-cyan-200">
                                    <p class="text-sm text-cyan-800 font-medium mb-1">
                                        <i class="fas fa-calendar-alt"></i> 
                                        Inicio: {{ item.curso.fecha_inicio|date:"d/m/Y" }}
                                    </p>
                                    <p class="text-sm text-cyan-800 font-medium mb-1">
                                        <i class="fas fa-clock"></i> 
                                        Duración: {{ item.curso.duracion_horas }} horas
                                    </p>
                                    <p class="text-sm text-cyan-800 font-medium">
                                        <i class="fas fa-user-md"></i> 
                                        Matrona: {{ item.curso.matrona.first_name }} {{ item.curso.matrona.last_name }}
                                    </p>
                                </div>
                            {% endif %}
                            
                            <p class="text-2xl font-bold text-instagram-pink">
                                ${{ item.precio|floatformat:0 }} CLP
                            </p>
                        </div>
                    </div>
                    
                    <form method="POST" action="{% url 'eliminaritemcarrito' item.id %}" class="ml-4 delete-item-form">
                        {% csrf_token %}
                        <button type="submit" 
                                class="text-instagram-red hover:bg-red-50 p-2 rounded-full transition-all"
                                onclick="return confirm('¿Eliminar este item del carrito?')">
                            <i class="fas fa-trash text-xl"></i>
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Resumen del carrito -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-md p-6 border border-border-color sticky top-24">
                <h3 class="text-xl font-bold mb-4 text-text-dark">Resumen del Pedido</h3>
                
                <!-- Sección de cupón -->
                <div class="mb-4 pb-4 border-b border-border-color">
                    <label class="block text-sm font-medium text-text-dark mb-2">
                        <i class="fas fa-ticket-alt mr-1"></i> ¿Tienes un cupón?
                    </label>
                    {% if carrito.cupon_aplicado %}
                    <div class="flex items-center gap-2 bg-green-50 border border-green-200 rounded-lg p-3">
                        <div class="flex-1">
                            <p class="text-sm font-bold text-green-700">{{ carrito.cupon_aplicado.codigo }}</p>
                            <p class="text-xs text-green-600">Cupón aplicado</p>
                        </div>
                        <button onclick="quitarCupon()" class="text-red-600 hover:text-red-700 p-1">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    {% else %}
                    <form id="cuponForm" onsubmit="aplicarCupon(event)" class="flex gap-2">
                        {% csrf_token %}
                        <input type="text" 
                               name="codigo_cupon" 
                               id="codigoCupon"
                               placeholder="Ingresa tu cupón" 
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-instagram-pink text-sm"
                               style="text-transform: uppercase;">
                        <button type="submit" 
                                class="px-4 py-2 bg-instagram-gradient text-white rounded-lg hover:shadow-lg transition-all text-sm font-medium">
                            Aplicar
                        </button>
                    </form>
                    <div id="cuponMessage" class="mt-2 text-sm"></div>
                    {% endif %}
                </div>
                
                <div class="border-t border-border-color pt-4 mb-4">
                    <div class="flex justify-between mb-2">
                        <span class="text-text-light">Subtotal ({{ items.count }})</span>
                        <span class="font-medium" id="subtotal">${{ carrito.subtotal|floatformat:0 }} CLP</span>
                    </div>
                    {% if carrito.cupon_aplicado %}
                    <div class="flex justify-between mb-2 text-green-600">
                        <span class="font-medium">
                            <i class="fas fa-tag mr-1"></i>
                            Descuento ({{ carrito.cupon_aplicado.codigo }})
                        </span>
                        <span class="font-bold" id="descuento">-${{ carrito.descuento|floatformat:0 }} CLP</span>
                    </div>
                    {% endif %}
                </div>
                
                <div class="border-t-2 border-border-color pt-4 mb-6">
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-bold">Total:</span>
                        <span class="text-2xl font-bold text-instagram-pink" id="total">${{ carrito.total|floatformat:0 }} CLP</span>
                    </div>
                </div>
                
                <form method="POST" action="{% url 'iniciar_pago' %}">
                    {% csrf_token %}
                    <button type="submit" class="w-full py-4 px-6 bg-gradient-to-r from-instagram-purple via-instagram-pink to-instagram-orange text-white font-bold rounded-xl hover:shadow-lg transition-all transform hover:-translate-y-1 mb-3">
                        <i class="fas fa-credit-card mr-2"></i>
                        Pagar con Webpay
                    </button>
                </form>
                
                <a href="{% url 'verservicio' %}" 
                   class="block w-full py-3 px-6 bg-gray-200 text-text-dark font-medium rounded-xl text-center hover:bg-gray-300 transition-all">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Seguir Comprando
                </a>
            </div>
        </div>
    </div>
    {% else %}
    <div class="text-center py-16">
        <div class="mb-6">
            <i class="fas fa-shopping-cart text-9xl text-gray-300"></i>
        </div>
        <h2 class="text-2xl font-bold text-text-dark mb-4">Tu carrito está vacío</h2>
        <p class="text-text-light mb-8">¡Agrega servicios para comenzar tu reserva!</p>
        <a href="{% url 'verservicio' %}" 
           class="inline-block py-4 px-8 bg-gradient-to-r from-instagram-purple via-instagram-pink to-instagram-orange text-white font-bold rounded-xl hover:shadow-lg transition-all transform hover:-translate-y-1">
            <i class="fas fa-plus mr-2"></i>
            Explorar Servicios
        </a>
    </div>
    {% endif %}
</div>

<script>
// Manejar eliminación de items con AJAX
document.querySelectorAll('.delete-item-form').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!confirm('¿Eliminar este servicio del carrito?')) {
            return;
        }
        
        const formData = new FormData(this);
        const url = this.action;
        const itemCard = this.closest('.bg-white');
        
        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Animar y remover el item
                itemCard.style.transition = 'all 0.3s ease';
                itemCard.style.opacity = '0';
                itemCard.style.transform = 'translateX(-20px)';
                
                setTimeout(() => {
                    itemCard.remove();
                    
                    // Actualizar contador del header
                    const cartCount = document.getElementById('cartCount');
                    if (cartCount) {
                        const currentCount = parseInt(cartCount.textContent);
                        const newCount = currentCount - 1;
                        if (newCount > 0) {
                            cartCount.textContent = newCount;
                        } else {
                            cartCount.remove();
                        }
                    }
                    
                    // Si no quedan items, mostrar mensaje vacío y recargar
                    const itemsContainer = document.querySelector('.lg\\:col-span-2');
                    if (itemsContainer && itemsContainer.querySelectorAll('.bg-white').length === 0) {
                        window.location.reload();
                    } else {
                        // Actualizar el total
                        location.reload();
                    }
                }, 300);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al eliminar el item');
        });
    });
});

// Función para aplicar cupón
function aplicarCupon(event) {
    event.preventDefault();
    
    const form = document.getElementById('cuponForm');
    const formData = new FormData(form);
    const messageDiv = document.getElementById('cuponMessage');
    const submitBtn = form.querySelector('button[type="submit"]');
    
    // Deshabilitar botón
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    fetch('{% url "aplicar_cupon" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageDiv.innerHTML = `<p class="text-green-600 font-medium"><i class="fas fa-check-circle mr-1"></i> ${data.mensaje}</p>`;
            // Recargar página para mostrar cupón aplicado
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            messageDiv.innerHTML = `<p class="text-red-600 font-medium"><i class="fas fa-exclamation-circle mr-1"></i> ${data.error}</p>`;
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Aplicar';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        messageDiv.innerHTML = '<p class="text-red-600 font-medium">Error al aplicar cupón</p>';
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Aplicar';
    });
}

// Función para quitar cupón
function quitarCupon() {
    if (!confirm('¿Deseas quitar el cupón aplicado?')) {
        return;
    }
    
    fetch('{% url "quitar_cupon" %}', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al quitar cupón');
    });
}

</script>
{% endblock %}
